<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Jigsaw Puzzle Maker</title>
<style>
  body {
    font-family: Quicksand, sans-serif;
    background: #fafafa;
    text-align: center;
    margin: 0;
    padding: 20px;
  }
  canvas {
    border: 2px solid #333;
    margin-top: 20px;
    cursor: grab;
  }
  select, button, input[type=file] {
    margin: 5px;
    padding: 5px 10px;
  }
  #controls {
    margin-bottom: 10px;
  }
</style>
</head>
<body>
  <h2>Single Page Jigsaw Puzzle</h2>
  <div id="controls">
    <input type="file" id="fileInput" accept="image/*" />
    <select id="difficulty">
      <option value="5">5 pieces</option>
      <option value="20">20 pieces</option>
      <option value="40">40 pieces</option>
      <option value="80">80 pieces</option>
      <option value="100">100 pieces</option>
    </select>
    <button id="startBtn">Start Puzzle</button>
  </div>
  <canvas id="puzzleCanvas" width="600" height="600"></canvas>
  <script>
    const canvas = document.getElementById('puzzleCanvas');
    const ctx = canvas.getContext('2d');
    const fileInput = document.getElementById('fileInput');
    const startBtn = document.getElementById('startBtn');
    const difficultySelect = document.getElementById('difficulty');

    let img = new Image();
    let pieces = [];
    let gridSize = 2;
    let pieceW, pieceH;
    let draggingPiece = null;
    let offsetX, offsetY;
    let isLoaded = false;

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        img = new Image();
        img.onload = () => {
          isLoaded = true;
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });

    startBtn.addEventListener('click', () => {
      if (!isLoaded) {
        alert('Please upload an image first.');
        return;
      }
      startPuzzle();
    });

    function startPuzzle() {
      const totalPieces = parseInt(difficultySelect.value);
      gridSize = Math.round(Math.sqrt(totalPieces));
      pieceW = canvas.width / gridSize;
      pieceH = canvas.height / gridSize;

      pieces = [];
      for (let y = 0; y < gridSize; y++) {
        for (let x = 0; x < gridSize; x++) {
          const piece = {
            correctX: x * pieceW,
            correctY: y * pieceH,
            x: Math.random() * (canvas.width - pieceW),
            y: Math.random() * (canvas.height - pieceH),
          };
          pieces.push(piece);
        }
      }
      drawPieces();
    }

    function drawPieces() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      pieces.forEach((p) => {
        ctx.drawImage(
          img,
          p.correctX * (img.width / canvas.width),
          p.correctY * (img.height / canvas.height),
          pieceW * (img.width / canvas.width),
          pieceH * (img.height / canvas.height),
          p.x,
          p.y,
          pieceW,
          pieceH
        );
      });
    }

    canvas.addEventListener('mousedown', (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      for (let i = pieces.length - 1; i >= 0; i--) {
        const p = pieces[i];
        if (x > p.x && x < p.x + pieceW && y > p.y && y < p.y + pieceH) {
          draggingPiece = p;
          offsetX = x - p.x;
          offsetY = y - p.y;
          break;
        }
      }
    });

    canvas.addEventListener('mousemove', (e) => {
      if (!draggingPiece) return;
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      draggingPiece.x = x - offsetX;
      draggingPiece.y = y - offsetY;
      drawPieces();
    });

    canvas.addEventListener('mouseup', () => {
      draggingPiece = null;
    });
  </script>
</body>
</html>
