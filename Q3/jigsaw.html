<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jigsaw Puzzle (rectangular pieces)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Quicksand',sans-serif;margin:18px;color:#222;display:flex;flex-direction:column;align-items:center}
    h1{font-size:20px;margin:0 0 12px}
    .controls{display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap;justify-content:center}
    select,input[type=file],button{padding:8px;border-radius:8px;border:1px solid #ddd;background:#fff}
    .pieces{display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin-bottom:20px;width:90%;min-height:120px;background:#fff;border:1px solid #eee;padding:10px;border-radius:10px;overflow:auto}
    .board{background:#f7f7f7;border:1px dashed #ddd;padding:12px;border-radius:10px;display:grid;align-items:center;justify-items:center;max-width:700px;max-height:500px}
    .piece{display:inline-block;border-radius:6px;box-shadow:0 4px 8px rgba(0,0,0,0.06);cursor:grab}
    .slot{background:linear-gradient(180deg,#fff,#fafafa);border:1px dashed #ccc;border-radius:6px;display:flex;align-items:center;justify-content:center}
    .slot.correct{border-style:solid;border-color:transparent}
    .slot img{display:block;max-width:100%;height:auto;border-radius:4px}
    .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:60}
    .modal{background:#fff;padding:20px;border-radius:12px;min-width:260px;text-align:center}
    .small{font-size:13px;color:#666}
    button:disabled{opacity:0.5}
  </style>

</head>
<body>
  <h1>Jigsaw Puzzle (rectangular pieces)</h1>
  <div class="controls">
    <label for="difficulty">Difficulty: </label>
    <select id="difficulty">
      <option value="5">Very Easy â€” 5</option>
      <option value="20">Easy â€” 20</option>
      <option value="40" selected>Medium â€” 40</option>
      <option value="80">Hard â€” 80</option>
      <option value="100">Very Hard â€” 100</option>
    </select>
    <input id="file" type="file" accept="image/*">
    <button id="startBtn">Start / Reset</button>
  </div>

  <div id="piecesContainer" class="pieces" aria-label="shuffled pieces">
    <div class="small">Upload an image and press Start.</div>
  </div>

  <div id="board" class="board" style="width:700px;height:500px;">Board will appear here</div>

  <div id="doneModal" class="overlay" style="display:none">
    <div class="modal">
      <h2>Congratulations â€” Puzzle complete ðŸŽ‰</h2>
      <p class="small">You placed all pieces correctly.</p>
      <button id="closeDone">Close</button>
    </div>
  </div>

  <script>
    function findGrid(n, aspect){
      let r = Math.floor(Math.sqrt(n));
      while(r > 1){ if(n % r === 0) break; r--; }
      if(r <= 1) r = 1;
      let c = Math.ceil(n / r);
      // adjust based on aspect ratio: if tall image, prefer more rows; if wide, prefer more cols
      if(aspect < 1 && r < c){ [r, c] = [c, r]; }
      return {rows: r, cols: c};
    }

    const fileInput = document.getElementById('file');
    const startBtn = document.getElementById('startBtn');
    const piecesContainer = document.getElementById('piecesContainer');
    const board = document.getElementById('board');
    const difficulty = document.getElementById('difficulty');
    const doneModal = document.getElementById('doneModal');
    const closeDone = document.getElementById('closeDone');

    let image = new Image();
    let pieceImages = [];
    let placedCount = 0;
    let selectedPieceId = null;

    fileInput.addEventListener('change', e=>{
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      const url = URL.createObjectURL(f);
      image = new Image();
      image.onload = ()=>{};
      image.src = url;
    });

    startBtn.addEventListener('click', ()=>{
      if(!image || !image.complete){ alert('Please select an image first.'); return; }
      startPuzzle();
    });

    function startPuzzle(){
      const n = parseInt(difficulty.value,10);
      const aspect = image.naturalWidth / image.naturalHeight;
      const grid = findGrid(n, aspect);
      const rows = grid.rows, cols = grid.cols;
      const total = rows * cols;

      const maxW = 700, maxH = 500;
      let scale = Math.min(maxW / image.naturalWidth, maxH / image.naturalHeight, 1);
      const iw = Math.floor(image.naturalWidth * scale);
      const ih = Math.floor(image.naturalHeight * scale);

      const pieceW = Math.floor(iw / cols);
      const pieceH = Math.floor(ih / rows);

      pieceImages = [];
      let index = 0;
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          if(index >= n) break;
          const sx = c * (image.naturalWidth / cols);
          const sy = r * (image.naturalHeight / rows);
          const sw = (c===cols-1)? (image.naturalWidth - sx) : (image.naturalWidth / cols);
          const sh = (r===rows-1)? (image.naturalHeight - sy) : (image.naturalHeight / rows);
          const cvs = document.createElement('canvas');
          cvs.width = pieceW; cvs.height = pieceH;
          const ctx = cvs.getContext('2d');
          ctx.drawImage(image, sx, sy, sw, sh, 0,0,pieceW,pieceH);
          const dataUrl = cvs.toDataURL();
          pieceImages.push({id:'p'+index, img:dataUrl, correctIndex:index});
          index++;
        }
      }

      const shuffled = pieceImages.slice();
      for(let i=shuffled.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [shuffled[i],shuffled[j]]=[shuffled[j],shuffled[i]]; }

      renderBoard(rows, cols, pieceImages.length, shuffled, iw, ih);
    }

    function renderBoard(rows, cols, totalPieces, shuffledPieces, iw, ih){
      piecesContainer.innerHTML=''; board.innerHTML='';

      board.style.width = iw+'px';
      board.style.height = ih+'px';

      const container = document.createElement('div');
      container.style.position='relative';
      container.style.display='grid';
      container.style.gridTemplateRows=`repeat(${rows},1fr)`;
      container.style.gridTemplateColumns=`repeat(${cols},1fr)`;
      container.style.width='100%';
      container.style.height='100%';
      container.style.gap='4px';

      for(let i=0;i<totalPieces;i++){
        const slot=document.createElement('div');
        slot.className='slot';
        slot.dataset.index=i;
        slot.addEventListener('dragover',ev=>{ev.preventDefault();slot.style.outline='2px solid #4caf50';});
        slot.addEventListener('dragleave',()=>slot.style.outline='');
        slot.addEventListener('drop',ev=>{ev.preventDefault();slot.style.outline='';const pid=ev.dataTransfer.getData('text/plain');placePieceInSlot(pid,slot);});
        slot.addEventListener('click',()=>{if(selectedPieceId)placePieceInSlot(selectedPieceId,slot);});
        container.appendChild(slot);
      }

      board.appendChild(container);

      shuffledPieces.forEach(p=>{
        const img=document.createElement('img');
        img.src=p.img; img.draggable=true; img.className='piece'; img.style.width='80px';
        img.dataset.id=p.id; img.dataset.correct=p.correctIndex;
        img.addEventListener('dragstart',ev=>ev.dataTransfer.setData('text/plain',p.id));
        img.addEventListener('click',()=>{if(selectedPieceId===p.id){selectedPieceId=null;img.style.outline='';}else{Array.from(piecesContainer.querySelectorAll('img')).forEach(x=>x.style.outline='');selectedPieceId=p.id;img.style.outline='3px solid #4caf50';}});
        piecesContainer.appendChild(img);
      });

      window._pieceMap={};
      shuffledPieces.forEach(p=>window._pieceMap[p.id]=p);
      placedCount=0;selectedPieceId=null;
    }

    function placePieceInSlot(pieceId,slotEl){
      if(!pieceId)return;
      const pieceData=window._pieceMap[pieceId];
      if(!pieceData)return;
      const slotIndex=Number(slotEl.dataset.index);
      if(slotEl.querySelector('img')){
        const existing=slotEl.querySelector('img');
        piecesContainer.appendChild(existing);
        if(Number(existing.dataset.correct)===slotIndex)placedCount=Math.max(0,placedCount-1);
      }
      const pieceEl=Array.from(piecesContainer.querySelectorAll('img')).find(x=>x.dataset.id===pieceId);
      if(pieceEl)piecesContainer.removeChild(pieceEl);

      const img=document.createElement('img');
      img.src=pieceData.img; img.draggable=true; img.dataset.id=pieceId; img.dataset.correct=pieceData.correctIndex; img.style.width='100%';
      img.addEventListener('dragstart',ev=>ev.dataTransfer.setData('text/plain',pieceId));
      img.addEventListener('click',()=>{piecesContainer.appendChild(img);slotEl.innerHTML='';if(Number(img.dataset.correct)===slotIndex)placedCount=Math.max(0,placedCount-1);checkComplete();});

      slotEl.innerHTML=''; slotEl.appendChild(img);

      if(Number(pieceData.correctIndex)===slotIndex){slotEl.classList.add('correct');placedCount++;}else slotEl.classList.remove('correct');

      selectedPieceId=null; Array.from(piecesContainer.querySelectorAll('img')).forEach(x=>x.style.outline='');
      checkComplete();
    }

    function checkComplete(){
      const totalSlots=board.querySelectorAll('.slot').length;
      if(placedCount===totalSlots)doneModal.style.display='flex';
    }

    closeDone.addEventListener('click',()=>doneModal.style.display='none');

    piecesContainer.addEventListener('dragover',ev=>ev.preventDefault());
    piecesContainer.addEventListener('drop',ev=>{ev.preventDefault();const pid=ev.dataTransfer.getData('text/plain');const fromSlot=board.querySelector(`.slot img[data-id="${pid}"]`);if(fromSlot){const ps=fromSlot.parentElement;ps.innerHTML='';if(Number(fromSlot.dataset.correct)===Number(ps.dataset.index))placedCount=Math.max(0,placedCount-1);}const pData=window._pieceMap[pid];if(pData){const img=document.createElement('img');img.src=pData.img;img.draggable=true;img.dataset.id=pData.id;img.dataset.correct=pData.correctIndex;img.style.width='80px';img.addEventListener('dragstart',ev=>ev.dataTransfer.setData('text/plain',pData.id));img.addEventListener('click',()=>{if(selectedPieceId===pData.id){selectedPieceId=null;img.style.outline='';}else{Array.from(piecesContainer.querySelectorAll('img')).forEach(x=>x.style.outline='');selectedPieceId=pData.id;img.style.outline='3px solid #4caf50';}});piecesContainer.appendChild(img);}checkComplete();});
  </script>
  <script src="track.js"></script>
</body>
</html>
